<!doctype HTML>
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>Assignment 1: Straightline Code</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="footnote.css" title="default"/><link rel="stylesheet" type="text/css" href="screen.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--><script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script><script>$.noConflict();</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ["$","$"], ["\\(","\\)"] ],
    displayMath: [ ["$$","$$"],
                   ["\\[","\\]"],
                   ["\\begin{equation}","\\end{equation}"],
                   ["\\begin{equation*}","\\end{equation*}"] ],
    processEscapes: true
  },
  "HTML-CSS": {
    availableFonts: ["Asana-Math", "STIX", "TeX"],
    webFont: "Asana-Math",
    preferredFont: "Asana-Math",
    imageFont: null,
    mtexFontInherit: true
  }
});</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="codemirror.js"></script><script src="runmode.js"></script><script src="scheme.js"></script><script src="mllike.js"></script><script src="rust.js"></script><script src="haskell.js"></script><script src="clike.js"></script><script src="javascript.js"></script><script src="asm86.js"></script><script src="asm64.js"></script><script src="shell.js"></script><script src="python.js"></script><script src="makefile-mode.js"></script><script src="setup-cm.js"></script></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="" class="tocviewselflink" data-pltdoc="x"><span class="AssignmentNum">Assignment 1:</span> Straightline Code</a></td></tr></table></div><div class="tocviewsublistonly" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="#%28part._.The_.Source_.Language%29" class="tocviewlink" data-pltdoc="x">The Source Language</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="#%28part._.Compilation_and_.Starter_.Code%29" class="tocviewlink" data-pltdoc="x">Compilation and Starter Code</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="#%28part._.Producing_executables_manually__installation_issues%29" class="tocviewlink" data-pltdoc="x">Producing executables manually, installation issues</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="#%28part._.Rust_.Tips%29" class="tocviewlink" data-pltdoc="x">Rust Tips</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="#%28part._.List_of_.Deliverables%29" class="tocviewlink" data-pltdoc="x">List of Deliverables</a></td></tr><tr><td align="right">6&nbsp;</td><td><a href="#%28part._.Grading_.Standards%29" class="tocviewlink" data-pltdoc="x">Grading Standards</a></td></tr><tr><td align="right">7&nbsp;</td><td><a href="#%28part._.Submission%29" class="tocviewlink" data-pltdoc="x">Submission</a></td></tr></table></div></div></div><div class="tocsub"><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber"></span><a href="#%28part._%29" class="tocsubseclink" data-pltdoc="x"><span class="AssignmentNum">Assignment 1:</span> Straightline Code</a></td></tr><tr><td><span class="tocsublinknumber">1<tt>&nbsp;</tt></span><a href="#%28part._.The_.Source_.Language%29" class="tocsubseclink" data-pltdoc="x">The Source Language</a></td></tr><tr><td><span class="tocsublinknumber">1.1<tt>&nbsp;</tt></span><a href="#%28part._.Concrete_.Syntax%29" class="tocsubseclink" data-pltdoc="x">Concrete Syntax</a></td></tr><tr><td><span class="tocsublinknumber">1.2<tt>&nbsp;</tt></span><a href="#%28part._.Abstract_.Syntax%29" class="tocsubseclink" data-pltdoc="x">Abstract Syntax</a></td></tr><tr><td><span class="tocsublinknumber">1.3<tt>&nbsp;</tt></span><a href="#%28part._.Semantics%29" class="tocsubseclink" data-pltdoc="x">Semantics</a></td></tr><tr><td><span class="tocsublinknumber">2<tt>&nbsp;</tt></span><a href="#%28part._.Compilation_and_.Starter_.Code%29" class="tocsubseclink" data-pltdoc="x">Compilation and Starter Code</a></td></tr><tr><td><span class="tocsublinknumber">2.1<tt>&nbsp;</tt></span><a href="#%28part._.Front_.End%29" class="tocsubseclink" data-pltdoc="x">Front End</a></td></tr><tr><td><span class="tocsublinknumber">2.2<tt>&nbsp;</tt></span><a href="#%28part._.Middle_.End%29" class="tocsubseclink" data-pltdoc="x">Middle End</a></td></tr><tr><td><span class="tocsublinknumber">2.3<tt>&nbsp;</tt></span><a href="#%28part._.Back_.End%29" class="tocsubseclink" data-pltdoc="x">Back End</a></td></tr><tr><td><span class="tocsublinknumber">2.4<tt>&nbsp;</tt></span><a href="#%28part._.Command-.Line_.Interface%29" class="tocsubseclink" data-pltdoc="x">Command-<wbr></wbr>Line Interface</a></td></tr><tr><td><span class="tocsublinknumber">2.5<tt>&nbsp;</tt></span><a href="#%28part._.Testing%29" class="tocsubseclink" data-pltdoc="x">Testing</a></td></tr><tr><td><span class="tocsublinknumber">3<tt>&nbsp;</tt></span><a href="#%28part._.Producing_executables_manually__installation_issues%29" class="tocsubseclink" data-pltdoc="x">Producing executables manually, installation issues</a></td></tr><tr><td><span class="tocsublinknumber">4<tt>&nbsp;</tt></span><a href="#%28part._.Rust_.Tips%29" class="tocsubseclink" data-pltdoc="x">Rust Tips</a></td></tr><tr><td><span class="tocsublinknumber">5<tt>&nbsp;</tt></span><a href="#%28part._.List_of_.Deliverables%29" class="tocsubseclink" data-pltdoc="x">List of Deliverables</a></td></tr><tr><td><span class="tocsublinknumber">6<tt>&nbsp;</tt></span><a href="#%28part._.Grading_.Standards%29" class="tocsubseclink" data-pltdoc="x">Grading Standards</a></td></tr><tr><td><span class="tocsublinknumber">7<tt>&nbsp;</tt></span><a href="#%28part._.Submission%29" class="tocsubseclink" data-pltdoc="x">Submission</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="versionNoNav">8.15</span></div><h2 class="heading"><a name="(part._)"></a><span class="AssignmentNum">Assignment 1:</span> Straightline Code<span class="button-group"><a href="#(part._)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h2><p><h4 class="due">Due: Fri 01/31 at 11:59pm</h4></p><p><p class="git-clone"><code><span class="kw">git clone </span><input onclick="this.select();" readonly="readonly" value="https://gitlab.eecs.umich.edu/483-wn25/straightline-code"/></code></p></p><p>In this assignment you&rsquo;ll implement a compiler for version 1.0 of the
Snake language (codename "Adder"). The adder source language is an
expression language supporting let-binding and binary arithmetic
operations and we will compile it into a single block of straightline
assembly code.</p><p>The "middle end" of the compiler will be covered in detail on January
22nd, but the frontend can be completed after the January 15 lecture,
and much of the backend as well.</p><h3 class="heading">1<tt>&nbsp;</tt><a name="(part._.The_.Source_.Language)"></a>The Source Language<span class="button-group"><a href="#(part._.The_.Source_.Language)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h3><p>There are a few pieces that go into defining a language for us to compile.</p><ul><li><p>A description of the concrete syntax &#8212;<wbr></wbr> the text the programmer writes</p></li><li><p>A description of the abstract syntax &#8212;<wbr></wbr> how to express what the
programmer wrote in a data structure our compiler uses.</p></li><li><p>The <span class="emph">semantics</span> &#8212; or description of the behavior &#8212; of the abstract
syntax, so our compiler knows what the code it generates should do.</p></li></ul><h4 class="heading">1.1<tt>&nbsp;</tt><a name="(part._.Concrete_.Syntax)"></a>Concrete Syntax<span class="button-group"><a href="#(part._.Concrete_.Syntax)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><blockquote class="SCodeFlow" style="white-space: pre;"><p><a name="(elem._(bnf-prod._(.Adder._prog)))"></a><span class="bnf-rule">&#8249;prog&#8250;</span><span class="bnf-meta">:</span> <span class="bnf-lit">def</span> <span class="bnf-lit">main</span> <span class="bnf-lit">(</span> <span class="bnf-lit bnf-unknown">IDENTIFIER</span> <span class="bnf-lit">)</span> <span class="bnf-lit">:</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Adder._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span>
<a name="(elem._(bnf-prod._(.Adder._expr)))"></a><span class="bnf-rule">&#8249;expr&#8250;</span><span class="bnf-meta">:</span> 
          <span class="bnf-meta"> | </span><span class="bnf-lit">let</span> <span class="bnf-lit bnf-unknown">IDENTIFIER</span> <span class="bnf-lit">=</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Adder._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">in</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Adder._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span>
          <span class="bnf-meta"> | </span><span class=""><a href="#%28elem._%28bnf-prod._%28.Adder._binop-expr%29%29%29" data-pltdoc="x">&#8249;binop-expr&#8250;</a></span>
<a name="(elem._(bnf-prod._(.Adder._binop-expr)))"></a><span class="bnf-rule">&#8249;binop-expr&#8250;</span><span class="bnf-meta">:</span> 
                      <span class="bnf-meta"> | </span><span class="bnf-lit bnf-unknown">NUMBER</span>
                      <span class="bnf-meta"> | </span><span class="bnf-lit bnf-unknown">IDENTIFIER</span>
                      <span class="bnf-meta"> | </span><span class=""><a href="#%28elem._%28bnf-prod._%28.Adder._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">+</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Adder._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span>
                      <span class="bnf-meta"> | </span><span class=""><a href="#%28elem._%28bnf-prod._%28.Adder._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">-</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Adder._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span>
                      <span class="bnf-meta"> | </span><span class=""><a href="#%28elem._%28bnf-prod._%28.Adder._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">*</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Adder._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span>
                      <span class="bnf-meta"> | </span><span class="bnf-lit">(</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Adder._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">)</span></p></blockquote><p>The main differences between this version of adder and the versions
introduced in lecture are that <span title="Adder" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">let</code></span> expressions can have one
<span class="emph">or many</span> bindings.  An <span class="bnf-lit
bnf-unknown">IDENTIFIER</span> is any non-sequence of letters and digits
(starting with a letter).  Any <span class="bnf-lit">highlighted</span>
text is a literal token, meaning the programmer must type exactly
those characters or keywords.</p><h4 class="heading">1.2<tt>&nbsp;</tt><a name="(part._.Abstract_.Syntax)"></a>Abstract Syntax<span class="button-group"><a href="#(part._.Abstract_.Syntax)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>The abstract syntax of Adder is a Rust datatype, and corresponds
closely with the concrete syntax. You don&rsquo;t have to worry
about implementing a parser, we have provided one for you that will
parse the concrete syntax into an abstract syntax tree.</p><p>The Adder program is parsed into the <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Prog</code></span> struct which contains
the input parameter name <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">param</code></span> and the main <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Expr</code></span> called
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">main</code></span>. An <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Expr</code></span> is either a number, a variable, a
primitive operation or a sequence of let-bindings. Each of these
constructors contains a <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">loc: SrcLoc</code></span> that corresponds to the
source location information for that sub-expression. This information
is only used to provide better error messages, you don&rsquo;t need to
inspect the internal details of <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">SrcLoc</code></span> type.</p><h4 class="heading">1.3<tt>&nbsp;</tt><a name="(part._.Semantics)"></a>Semantics<span class="button-group"><a href="#(part._.Semantics)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>An Adder program takes in a single 64-bit integer as input and evaluates to a single 64-bit integer.  <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Num</code></span>s
evaluate to themselves (so a program just consisting of <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Num(5)</code></span>
should evaluate to the integer <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">5</code></span>).  Primitive expressions
perform addition or subtraction by one on their argument. Let
bindings should evaluate all the binding expressions to values one by
one, and after each, store a mapping from the given name to the
corresponding value in both (a) the rest of the bindings, and (b) the
body of the let expression. Identifiers evaluate to whatever their
current stored value is.  There are several examples further down to
make this concrete.</p><p><p>The compiler should return an error if
</p><ul><li><p>There is a binding list containing two or more bindings with the same name</p></li><li><p>An identifier is unbound (there is no surrounding let binding for it)</p></li></ul><p>These errors are encoded in the <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">CompileError</code></span> type in
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">compile.rs</code></span>.</p></p><p>Note that shadowing of variables is allowed, but all variable names in
a single binding list must be unique. So</p><p><div class="sourceCodeWrapper"><span data-label="Adder" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-snake" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">let x = 3 in
let x = 4 in
x</code></pre></div></div></p><p>is a valid program, but</p><p><div class="sourceCodeWrapper"><span data-label="Adder" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-snake" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">let x = 3, x = 4 in
x</code></pre></div></div></p><p>should produce a compile-time error.</p><p>Here are some examples of Adder expressions and how they parse into Rust values (ignoring the <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">SrcLoc</code></span> information):</p><p><table cellspacing="0" cellpadding="0" class="centered" style="border-collapse: collapse;"><tr><td style="border-bottom: 1px solid black;"><p>Concrete Syntax</p></td><td style="border-bottom: 1px solid black;"><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p></td><td style="border-bottom: 1px solid black;"><p>Abstract Syntax</p></td><td style="border-bottom: 1px solid black;"><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p></td><td style="border-bottom: 1px solid black;"><p>Result</p></td></tr><tr><td><p><div class="sourceCodeWrapper"><span data-label="Adder" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-snake" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">5</code></pre></div></div></p></td><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p></td><td><p><div class="sourceCodeWrapper"><span data-label="Rust" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-rustsrc" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Num(5)</code></pre></div></div></p></td><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p></td><td><p><code>5</code></p></td></tr><tr><td><p><div class="sourceCodeWrapper"><span data-label="Adder" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-snake" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">sub1(add1(sub1(5)))</code></pre></div></div></p></td><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p></td><td><p><div class="sourceCodeWrapper"><span data-label="Rust" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-rustsrc" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Prim{ prim: Sub1, args: [ Prim{ prim: Add1, args: [ Prim{ prim: Sub1, args: [ Num(5)]}]}]}</code></pre></div></div></p></td><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p></td><td><p><code>4</code></p></td></tr><tr><td><p><div class="sourceCodeWrapper"><span data-label="Adder" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-snake" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">let x = 5 in add1(x)</code></pre></div></div></p></td><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p></td><td><p><div class="sourceCodeWrapper"><span data-label="Rust" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-rustsrc" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Let{ bindings: [Binding { var: "x" , expr: Num(5)} ],
     body: Prim{ prim: Add1, args: [Var("x")]} } </code></pre></div></div></p></td><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p></td><td><p><code>6</code></p></td></tr><tr><td><p><div class="sourceCodeWrapper"><span data-label="Adder" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-snake" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">let x = 5,
    y = sub1(x)
in sub1(y)</code></pre></div></div></p></td><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p></td><td><p><div class="sourceCodeWrapper"><span data-label="Rust" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-rustsrc" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Let{ bindings: [Binding{ var: "x", expr: Num(5) },
                Binding{ var: "y", expr: Prim{ prim: Sub1, args{ [ Var("y") ]}}}],
     body: Prim{ prim: Sub1, args: [ Var("y") ]}}</code></pre></div></div></p></td><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p></td><td><p><code>3</code></p></td></tr><tr><td><p><div class="sourceCodeWrapper"><span data-label="Adder" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-snake" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">4 + 7 * 3</code></pre></div></div></p></td><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p></td><td><p><div class="sourceCodeWrapper"><span data-label="Rust" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-rustsrc" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Prim{ prim: Add, args: [ Var("x"), Prim{ prim: Mul, args: [ Num(7), Var("y")]}]}</code></pre></div></div></p></td><td><p><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p></td><td><p><code>25</code></p></td></tr></table></p><p>Your program will not just be a single expression, but a main function that takes an input, for instance the program</p><p><div class="sourceCodeWrapper"><span data-label="Adder" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-snake" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">def main(x):
  x * x</code></pre></div></div>
will be parsed into the abstract syntax
<div class="sourceCodeWrapper"><span data-label="Rust" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-rustsrc" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Prog { param: ("x") , main: Prim{ prim: Mul, args: [ Var("x"), Var("x") ]} }</code></pre></div></div></p><p>and its semantics is a function that outputs the square of the input.</p><h3 class="heading">2<tt>&nbsp;</tt><a name="(part._.Compilation_and_.Starter_.Code)"></a>Compilation and Starter Code<span class="button-group"><a href="#(part._.Compilation_and_.Starter_.Code)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h3><p><p>The starter code provides much of the architecture of the compiler already:
</p><ul><li><p><code>mk_submission.sh</code>, a script that creates a zip file with the correct files to be submitted to the autograder.</p></li><li><p><code>Cargo.toml</code> the package description file.</p></li><li><p><code>runtime/stub.rs</code> a Rust wrapper that calls our compiled assembly code function with an argument provided from the command line</p></li><li><p><code>src/main.rs</code>, <code>src/compile.rs</code> and <code>runner.rs</code> are wrappers providing a command line interface to the compiler pipeline and interpreters. You should look at <code>src/compile.rs</code> to see how the compiler pipeline functions.</p></li><li><p><code>src/ast.rs</code>, <code>src/ssa.rs</code> and <code>src/asm.rs</code> have type definitions for the abstract syntax trees, intermediate representation and assembly code, respectively</p></li><li><p><code>src/interp.rs</code> and <code>src/pretty.rs</code> implement interpreters and pretty printers for abstract syntax trees and the intermediate representation</p></li><li><p><code>src/identifiers.rs</code> utilities for working with identifiers.</p></li><li><p><code>src/parser.rs</code>, generated code for lexing and parsing source programs into abstract syntax trees, which is generated from <code>src/parser.lalrpop</code> using the Lalrpop parser generator.</p></li><li><p><code>examples/</code> a directory for putting example programs</p></li><li><p><code>tests/examples.rs</code> a file with some testing macros to help you test your compiler against the examples in <code>examples/</code></p></li></ul></p><p>You will complete the implementation of the compilation pipeline in three files: <code>front_end.rs</code>, <code>middleend.rs</code> and <code>back_end.rs</code>.</p><h4 class="heading">2.1<tt>&nbsp;</tt><a name="(part._.Front_.End)"></a>Front End<span class="button-group"><a href="#(part._.Front_.End)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>After the program is parsed into an abstract syntax tree, the final
stage of the front end is to ensure that the program satisfies the
scoping rules for the language: all variables are declared before they
are used and that multiple-let forms do not declare the same variable
more than once. These errors are defined in <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">CompileError</code></span>.
Additionally, to avoid having to deal with shadowing later in the
compiler, we want to resolve the source-level identifiers into unique
identifiers for use in the remainder of the compiler.
This functionality is implemented in the <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">resolve_prog</code></span> method of the <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Resolver</code></span> struct, a simple wrapper object that is used as a source of unique identifiers.
Your task is to fill in the details of <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">resolve_prog</code></span> sub-procedure for this method. You will need to choose an appropriate notion of auxiliary <span class="emph">environment</span> to correctly implement this functionality.  As in class, you may find it useful to use the <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">HashMap</code></span> from the <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">im</code></span> package, a package for immutable data structures that support sharing. The documentation for this data structure is <a href="https://docs.rs/im/latest/im/hashmap/struct.HashMap.html">here</a>, most relevant are the <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">new</code></span>, <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">get</code></span> and <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">insert</code></span> methods.</p><h4 class="heading">2.2<tt>&nbsp;</tt><a name="(part._.Middle_.End)"></a>Middle End<span class="button-group"><a href="#(part._.Middle_.End)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>As discussed in lecture on January 22nd, we next want to make the
execution order of our program explicit by compiling it into our
intermediate representation, a <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">BlockBody</code></span> of straight-line code,
defined in <code>src/ssa.rs</code>. A <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">BlockBody</code></span> is either
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Returns</code></span> and immediate value or it performs an <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Operation</code></span>,
binds that to a <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">dest</code></span> variable and then continues with a
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">next</code></span> <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">BlockBody</code></span>.</p><p>This lowering is implemented as a method <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">lower_prog</code></span> around the
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Lowerer</code></span> struct. Your task is to implement the core
sub-procedure for this lowering process, <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">lower_expr_kont</code></span>. The
parameter <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">k</code></span> is the <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Continuation</code></span> of the code you are
lowering, that is, it is a pair of a destination variable where the
output of the current expression should be stored and a
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">BlockBody</code></span> that will execute after the current expression. The
initial continuation is provided in <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">lower_prog</code></span> to just return
the output, but you will build this up recursively in order to produce
your flattened code from a tree.</p><h4 class="heading">2.3<tt>&nbsp;</tt><a name="(part._.Back_.End)"></a>Back End<span class="button-group"><a href="#(part._.Back_.End)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>To implement the final code generation phase of the pipeline, we need a way to map the variables in our intermediate representation into concrete memory locations. As discussed in lecture, we will store our local variables on the stack, as a memory locations relative to the stack pointer <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">rsp</code></span>. Concretely, in <code>backend.rs</code>, you will implement the <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">emit_prog</code></span> function, which produces assembly instructions from the intermediate representation. We have already provided the outline of the <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">emit</code></span> function, which sets up the correct <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">.text</code></span> section and <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">global</code></span> declarations to link with <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">runtime/stub.rs</code></span>. In doing so, you will need to design and maintain some kind of environment for mapping the intermediate representation variables to stack offsets.</p><h4 class="heading">2.4<tt>&nbsp;</tt><a name="(part._.Command-.Line_.Interface)"></a>Command-Line Interface<span class="button-group"><a href="#(part._.Command-.Line_.Interface)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>To build the command-line interface run <code>cargo build --release</code>,
after which the executable will be available at
<code>target/release/snake</code>. Run <code>./target/release/snake --help</code>
for an overview of the command-line interface.  To help you implement
your compiler gradually, the command-line interface that supports
partial execution of the compiler pipeline. That is, you can pass the
<code>--target tgt</code> or <code>-t tgt</code> option to specify that you want
the compiler to produce an ast, a resolved ast, your ssa intermediate
representation, your assembly code, or the linked executable. You can
also pass the <code>--execute n</code> or <code>-x n</code> option to say to run
your code with the input argument <code>n</code>. By default this will
compile your program to an executable and then run it, but if you
select an (resolved) ast or ssa this will run the provided interpreter
instead.</p><h4 class="heading">2.5<tt>&nbsp;</tt><a name="(part._.Testing)"></a>Testing<span class="button-group"><a href="#(part._.Testing)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h4><p>The file <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">test/examples.rs</code></span> contains utilities for testing the
output of your compiler against example programs you include in the
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">examples/</code></span> directory. We have provided a few examples to show
how you can use this to test your end-to-end compiler pipeline, as
well as the front end and middle ends.
You can execute the command <code>cargo test</code> to run your tests.</p><h3 class="heading">3<tt>&nbsp;</tt><a name="(part._.Producing_executables_manually__installation_issues)"></a>Producing executables manually, installation issues<span class="button-group"><a href="#(part._.Producing_executables_manually__installation_issues)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h3><p>On any platform you need to have <span title="Shell" class="sourceCode"><code data-lang="text/x-sh" class="sourceCode">nasm</code></span> and <span title="Shell" class="sourceCode"><code data-lang="text/x-sh" class="sourceCode">ar</code></span>
installed. Ask on Piazza if you have any issues installing these. If
you have installed these correctly and are using Mac or Linux the
runner should correctly use the right flags for your platform when
creating the final binary.</p><p>Here are the explicit commands the starter code uses to build an executable
from an assembly code file <span title="Shell" class="sourceCode"><code data-lang="text/x-sh" class="sourceCode">compiled_code.s</code></span> and the rust stub
<span title="Shell" class="sourceCode"><code data-lang="text/x-sh" class="sourceCode">stub.rs</code></span>. First build an object file using <span title="Shell" class="sourceCode"><code data-lang="text/x-sh" class="sourceCode">nasm</code></span>,
passing the appropriate format flag for your platform.</p><p><div class="sourceCodeWrapper"><span data-label="Shell" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-sh" class="sourceCode"><code data-lang="text/x-sh" class="sourceCode">$ nasm -felf64 compiled_code.s -o compiled_code.o   # Linux
$ nasm -fmacho64 compiled_code.s -o compiled_code.o # Mac</code></pre></div></div></p><p>Then build a static library file to link with the rust file
<div class="sourceCodeWrapper"><span data-label="Shell" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-sh" class="sourceCode"><code data-lang="text/x-sh" class="sourceCode">$ ar r libcompiled_code.a compiled_code.o # Linux &amp; Mac</code></pre></div></div></p><p>Finally, compile the rust file, indicating where to look for the static library.</p><p><div class="sourceCodeWrapper"><span data-label="Shell" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-sh" class="sourceCode"><code data-lang="text/x-sh" class="sourceCode">$ rustc stub.rs -L . -o stub.exe                              # Linux
$ rustc stub.rs -L . --target x86_64-apple-darwin -o stub.exe # Mac</code></pre></div></div></p><p>This should make an executable that you can run.
<div class="sourceCodeWrapper"><span data-label="Shell" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-sh" class="sourceCode"><code data-lang="text/x-sh" class="sourceCode">$ ./stub.exe</code></pre></div></div></p><p>We recommend you try this out with the sample file
<div class="sourceCodeWrapper"><span data-label="X64 Assembly" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-asm64" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">section .text
global start_here
start_here:
  mov rax, 483
  ret</code></pre></div></div>
To make sure you have installed <span title="Shell" class="sourceCode"><code data-lang="text/x-sh" class="sourceCode">nasm</code></span> and <span title="Shell" class="sourceCode"><code data-lang="text/x-sh" class="sourceCode">ar</code></span> correctly.</p><h3 class="heading">4<tt>&nbsp;</tt><a name="(part._.Rust_.Tips)"></a>Rust Tips<span class="button-group"><a href="#(part._.Rust_.Tips)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h3><p>To read more about pattern matching on Rust enums see
<a href="https://doc.rust-lang.org/stable/book/ch18-03-pattern-syntax.html">this
chapter of the Rust book</a>.</p><p>In checking binding-lists for duplicates you might want to use a data
structure to keep track of the names. For this you may want to try out
the
<a href="https://doc.rust-lang.org/std/collections/struct.HashSet.html#">HashSet
module in the standard library or the <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">im</code></span> library</a>.</p><h3 class="heading">5<tt>&nbsp;</tt><a name="(part._.List_of_.Deliverables)"></a>List of Deliverables<span class="button-group"><a href="#(part._.List_of_.Deliverables)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h3><p>For this assignment you will submit your updated versions of three
files:</p><ul><li><p>src/frontend.rs</p></li><li><p>src/middle_end.rs</p></li><li><p>src/backend.rs</p></li></ul><p>These are the only files that you can change in your submission, your
code will be linked with reference versions of the other files.</p><p>We&rsquo;ve included a script <span title="Shell" class="sourceCode"><code data-lang="text/x-sh" class="sourceCode">mk_submission.sh</code></span> in the starter code
repo that should make zip file with just those three files and your
testing files that you should upload to gradescope. The testing files
are included for us to get some idea of how students are testing their
code, they are not graded.</p><h3 class="heading">6<tt>&nbsp;</tt><a name="(part._.Grading_.Standards)"></a>Grading Standards<span class="button-group"><a href="#(part._.Grading_.Standards)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h3><p>For this assignment, you will be autograded on whether your code
implements the specification (functional correctness). We encourage
you to test but your test coverage is not graded.</p><h3 class="heading">7<tt>&nbsp;</tt><a name="(part._.Submission)"></a>Submission<span class="button-group"><a href="#(part._.Submission)" class="heading-anchor" title="Link to here">ðŸ”—</a><span style="visibility: hidden"> </span></span></h3><p><p><span style="font-weight: bold">Wait!</span> Please read the assignment again and verify that you have not forgotten anything!</p></p><p>Please submit your homework on gradescope by the above deadline.</p><a name="(part._(gentag._0._assignmentstraightline-code))"></a><p class="FootnoteBlock"></p></div></div><div id="contextindicator">&nbsp;</div></body></html>