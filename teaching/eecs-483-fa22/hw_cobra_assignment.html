<!doctype HTML>
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>Assignment 3: Cobra: Multiple types of values</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="footnote.css" title="default"/><link rel="stylesheet" type="text/css" href="screen.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--><script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script><script>$.noConflict();</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ["$","$"], ["\\(","\\)"] ],
    displayMath: [ ["$$","$$"],
                   ["\\[","\\]"],
                   ["\\begin{equation}","\\end{equation}"],
                   ["\\begin{equation*}","\\end{equation*}"] ],
    processEscapes: true
  },
  "HTML-CSS": {
    availableFonts: ["Asana-Math", "STIX", "TeX"],
    webFont: "Asana-Math",
    preferredFont: "Asana-Math",
    imageFont: null,
    mtexFontInherit: true
  }
});</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="codemirror.js"></script><script src="runmode.js"></script><script src="scheme.js"></script><script src="mllike.js"></script><script src="rust.js"></script><script src="haskell.js"></script><script src="clike.js"></script><script src="javascript.js"></script><script src="asm86.js"></script><script src="asm64.js"></script><script src="shell.js"></script><script src="python.js"></script><script src="makefile-mode.js"></script><script src="setup-cm.js"></script></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="" class="tocviewselflink" data-pltdoc="x"><span class="AssignmentNum">Assignment 3:</span> Cobra:<span class="mywbr"> &nbsp;</span> Multiple types of values</a></td></tr></table></div><div class="tocviewsublistonly" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="#%28part._.The_.Cobra_.Language%29" class="tocviewlink" data-pltdoc="x">The Cobra Language</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="#%28part._.Examples%29" class="tocviewlink" data-pltdoc="x">Examples</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="#%28part._.Implementation_strategies%29" class="tocviewlink" data-pltdoc="x">Implementation strategies</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="#%28part._.Recommended_.T.O.D.O_.List%29" class="tocviewlink" data-pltdoc="x">Recommended TODO List</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="#%28part._.Running_main%29" class="tocviewlink" data-pltdoc="x">Running main</a></td></tr><tr><td align="right">6&nbsp;</td><td><a href="#%28part._.List_of_.Deliverables%29" class="tocviewlink" data-pltdoc="x">List of Deliverables</a></td></tr><tr><td align="right">7&nbsp;</td><td><a href="#%28part._.Grading_.Standards%29" class="tocviewlink" data-pltdoc="x">Grading Standards</a></td></tr><tr><td align="right">8&nbsp;</td><td><a href="#%28part._.Submission%29" class="tocviewlink" data-pltdoc="x">Submission</a></td></tr></table></div></div></div><div class="tocsub"><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber"></span><a href="#%28part._%29" class="tocsubseclink" data-pltdoc="x"><span class="AssignmentNum">Assignment 3:</span> Cobra:<span class="mywbr"> &nbsp;</span> Multiple types of values</a></td></tr><tr><td><span class="tocsublinknumber">1<tt>&nbsp;</tt></span><a href="#%28part._.The_.Cobra_.Language%29" class="tocsubseclink" data-pltdoc="x">The Cobra Language</a></td></tr><tr><td><span class="tocsublinknumber">1.1<tt>&nbsp;</tt></span><a href="#%28part._.Concrete_.Syntax%29" class="tocsubseclink" data-pltdoc="x">Concrete Syntax</a></td></tr><tr><td><span class="tocsublinknumber">1.2<tt>&nbsp;</tt></span><a href="#%28part._.Abstract_.Syntax%29" class="tocsubseclink" data-pltdoc="x">Abstract Syntax</a></td></tr><tr><td><span class="tocsublinknumber">1.3<tt>&nbsp;</tt></span><a href="#%28part._.Semantics%29" class="tocsubseclink" data-pltdoc="x">Semantics</a></td></tr><tr><td><span class="tocsublinknumber">2<tt>&nbsp;</tt></span><a href="#%28part._.Examples%29" class="tocsubseclink" data-pltdoc="x">Examples</a></td></tr><tr><td><span class="tocsublinknumber">3<tt>&nbsp;</tt></span><a href="#%28part._.Implementation_strategies%29" class="tocsubseclink" data-pltdoc="x">Implementation strategies</a></td></tr><tr><td><span class="tocsublinknumber">3.1<tt>&nbsp;</tt></span><a href="#%28part._.Rendering_errors%29" class="tocsubseclink" data-pltdoc="x">Rendering errors</a></td></tr><tr><td><span class="tocsublinknumber">3.2<tt>&nbsp;</tt></span><a href="#%28part._.Memory_.Layout_and_.Calling_.Rust_.Functions%29" class="tocsubseclink" data-pltdoc="x">Memory Layout and Calling Rust Functions</a></td></tr><tr><td><span class="tocsublinknumber">3.3<tt>&nbsp;</tt></span><a href="#%28part._.New_.Assembly_.Constructs%29" class="tocsubseclink" data-pltdoc="x">New Assembly Constructs</a></td></tr><tr><td><span class="tocsublinknumber">3.4<tt>&nbsp;</tt></span><a href="#%28part._.Debugging%29" class="tocsubseclink" data-pltdoc="x">Debugging</a></td></tr><tr><td><span class="tocsublinknumber">4<tt>&nbsp;</tt></span><a href="#%28part._.Recommended_.T.O.D.O_.List%29" class="tocsubseclink" data-pltdoc="x">Recommended TODO List</a></td></tr><tr><td><span class="tocsublinknumber">5<tt>&nbsp;</tt></span><a href="#%28part._.Running_main%29" class="tocsubseclink" data-pltdoc="x">Running main</a></td></tr><tr><td><span class="tocsublinknumber">6<tt>&nbsp;</tt></span><a href="#%28part._.List_of_.Deliverables%29" class="tocsubseclink" data-pltdoc="x">List of Deliverables</a></td></tr><tr><td><span class="tocsublinknumber">7<tt>&nbsp;</tt></span><a href="#%28part._.Grading_.Standards%29" class="tocsubseclink" data-pltdoc="x">Grading Standards</a></td></tr><tr><td><span class="tocsublinknumber">8<tt>&nbsp;</tt></span><a href="#%28part._.Submission%29" class="tocsubseclink" data-pltdoc="x">Submission</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="versionNoNav">8.6</span></div><h2><a name="(part._)"></a><span class="AssignmentNum">Assignment 3:</span> Cobra: Multiple types of values</h2><p><h4 class="due">Due: Fri 10/14 at 5:00pm</h4></p><p><p class="git-clone"><code><span class="kw">git clone </span><input onclick="this.select();" readonly="readonly" value="https://gitlab.eecs.umich.edu/483-fa22/starter-code/cobra"/></code></p></p><p><span class="emph">In this compiler, you&rsquo;ll deal with COded Binary RepresntAtions of values. <a href="https://upload.wikimedia.org/wikipedia/commons/thumb/9/94/Indian_Cobra.JPG/1920px-Indian_Cobra.JPG">Click here for scary snake picture!</a></span></p><h3>1<tt>&nbsp;</tt><a name="(part._.The_.Cobra_.Language)"></a>The Cobra Language</h3><h4>1.1<tt>&nbsp;</tt><a name="(part._.Concrete_.Syntax)"></a>Concrete Syntax</h4><p>The concrete syntax of Cobra is very similar to Boa, with a few new additions.</p><blockquote class="SCodeFlow" style="white-space: pre;"><p><a name="(elem._(bnf-prod._(.Cobra._expr)))"></a><span class="bnf-rule">&#8249;expr&#8250;</span><span class="bnf-meta">:</span> <span class="bnf-lit bnf-unknown">...</span>
          <span class="bnf-meta"> | </span><span class="bnf-lit">true</span>
          <span class="bnf-meta"> | </span><span class="bnf-lit">false</span>
          <span class="bnf-meta"> | </span><span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">&lt;</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span>
          <span class="bnf-meta"> | </span><span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">&gt;</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span>
          <span class="bnf-meta"> | </span><span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">&lt;=</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span>
          <span class="bnf-meta"> | </span><span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">&gt;=</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span>
          <span class="bnf-meta"> | </span><span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">==</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span>
          <span class="bnf-meta"> | </span><span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">&amp;&amp;</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span>
          <span class="bnf-meta"> | </span><span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">||</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span>
          <span class="bnf-meta"> | </span><span class="bnf-lit">!</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span>
          <span class="bnf-meta"> | </span><span class="bnf-lit">isbool</span> <span class="bnf-lit">(</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">)</span>
          <span class="bnf-meta"> | </span><span class="bnf-lit">isnum</span> <span class="bnf-lit">(</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">)</span>
          <span class="bnf-meta"> | </span><span class="bnf-lit">print</span> <span class="bnf-lit">(</span> <span class=""><a href="#%28elem._%28bnf-prod._%28.Cobra._expr%29%29%29" data-pltdoc="x">&#8249;expr&#8250;</a></span> <span class="bnf-lit">)</span></p></blockquote><h4>1.2<tt>&nbsp;</tt><a name="(part._.Abstract_.Syntax)"></a>Abstract Syntax</h4><p>The abstract syntax is very similar to Boa, also:
<div class="sourceCodeWrapper"><span data-label="Rust" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-rustsrc" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">pub enum Prim1 {
    ...
    Not,
    Print,
    IsBool,
    IsNum,
}
pub enum Prim2 {
    ...
    And,
    Or,
    Lt,
    Gt,
    Le,
    Ge,
    Eq,
}

pub enum Exp&lt;Ann&gt; {
    ...
    Bool(bool, Ann),
}</code></pre></div></div></p><h4>1.3<tt>&nbsp;</tt><a name="(part._.Semantics)"></a>Semantics</h4><p>The semantics of booleans are straightforward.  The semantics of
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Exp::If</code></span> changes slightly: its condition must evaluate to a
boolean, and it branches on the truth or falsehood of that value,
rather than whether it&rsquo;s nonzero.</p><p>With the addition of two types to the language, there are two main changes that
ripple through the implementation:</p><ul><li><p>The representation of values</p></li><li><p>The possibility of errors</p></li></ul><p>There is one other major addition, which is the <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">print</code></span>
primitive, discussed more below.</p><p>The representation of values requires a definition. We&rsquo;ll use the following
representations for the Cobra runtime:</p><ul><li><p><span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">true</code></span> will be represented as the constant
<span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">0xFFFFFFFFFFFFFFFF</code></span>.</p></li><li><p><span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">false</code></span> will be represented as the constant
<span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">0x7FFFFFFFFFFFFFFF</code></span>.</p></li><li><p>numbers will be represented with a zero in the rightmost bit, by shifting
them left 1 bit. So, for example, 2 is represented as <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">0x0000000000000004</code></span>.</p></li></ul><p>You should raise errors at runtime in the following cases:</p><ul><li><p><span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">-</code></span>, <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">+</code></span>, <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">*</code></span>, <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">add1</code></span> and <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">sub1</code></span> should raise an error (by
printing it out) with the substring <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">"arithmetic expected a number"</code></span> if the
operation&rsquo;s argument(s) are not numbers.  You can print more information than
this if you like, but the message must have at least this substring.</p></li><li><p><span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">&lt;</code></span>, <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">&lt;=</code></span>, <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">&gt;</code></span> and <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">&gt;=</code></span> should raise an error with the
substring <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">"comparison expected a number"</code></span> if the arguments are not both numbers.</p></li><li><p><span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">+</code></span>, <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">-</code></span>, <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">*</code></span>, <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">add1</code></span> and <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">sub1</code></span> should raise an error
with the substring <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">"overflow"</code></span> if the result overflows, and falls outside
the range representable in 63 bits. The <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">jo</code></span> instruction will be useful: it
jumps if the last instruction overflowed.</p></li><li><p><span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">if</code></span> should raise an error with the substring <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">"if expected a boolean"</code></span>
if the conditional value is not a boolean.</p></li><li><p><span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">and</code></span> and <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">or</code></span> should raise an error with the
substring <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">"logic expected a boolean"</code></span> if the arguments are not
both booleans. Implementation of short-circuiting behavior is optional.</p></li><li><p><span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">not</code></span> should raise an error with the substring <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">"logic expected
a boolean"</code></span> if its argument is not a boolean.</p></li></ul><p>These error messages should be printed on standard error. The other operators
never fail, and so never produce errors.</p><p>The <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">==</code></span> should work polymorphically, regardless of the types of
its inputs. If we ask if a boolean is equal to a number, the result
should be <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">false</code></span>, not a runtime error. A value is only
<span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">==</code></span> to itself.</p><p>We add two new primitive operations, <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">isbool</code></span> and <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">isnum</code></span>.  These two
operations have an effective type of <span title="OCaml" class="sourceCode"><code data-lang="text/x-ocaml" class="sourceCode">Any -&gt; Bool</code></span>, and will return
<span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">true</code></span> if the argument they receive is indeed a boolean or number,
respectively.</p><p>The last required primitive operation is <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">print</code></span>, which prints
its single argument to the command line (with a newline), and then
returns it.  The <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">print_snake_val</code></span> function in <code>stub.rs</code>
explicitly returns its argument; you will need to retrieve and use
that value in your compiled output.</p><h3>2<tt>&nbsp;</tt><a name="(part._.Examples)"></a>Examples</h3><ol><li><p>The expression</p><p><div class="sourceCodeWrapper"><span data-label="Cobra" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-snake" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">let x = 1 in
let y = print(x + 1) in
print(y + 2)</code></pre></div></div></p><p>will output
<div class="sourceCodeWrapper"><span data-label="Shell" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-sh" class="sourceCode"><code data-lang="text/x-sh" class="sourceCode">2
4
4</code></pre></div></div></p><p>The first 2 comes from the first <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">print</code></span> expression. The first 4 comes from the
second <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">print</code></span> expression. The final line prints the answer of the program as
usual, so there&rsquo;s an &ldquo;extra&rdquo; 4.</p></li><li><p>The expression</p><p><div class="sourceCodeWrapper"><span data-label="Cobra" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-snake" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">if 54: true else: false</code></pre></div></div></p><p>prints (on standard error) something like:</p><p><div class="sourceCodeWrapper"><span data-label="Shell" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-sh" class="sourceCode"><code data-lang="text/x-sh" class="sourceCode">Error: if expected a boolean, got 54</code></pre></div></div></p></li></ol><h3>3<tt>&nbsp;</tt><a name="(part._.Implementation_strategies)"></a>Implementation strategies</h3><h4>3.1<tt>&nbsp;</tt><a name="(part._.Rendering_errors)"></a>Rendering errors</h4><p>To display error messages on standard error, you&rsquo;ll need to use a call something like:</p><p><div class="sourceCodeWrapper"><span data-label="C/C++" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-csrc" class="sourceCode"><code data-lang="text/x-csrc" class="sourceCode">eprintln!("Error: if expected a boolean");</code></pre></div></div></p><p>I have included a function <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">snake_error()</code></span> in <code>stub.rs</code>. You
will need to add inputs of your design to this function to get your
desired error messages. You can follow what we did in class or design
it however you like.</p><h4>3.2<tt>&nbsp;</tt><a name="(part._.Memory_.Layout_and_.Calling_.Rust_.Functions)"></a>Memory Layout and Calling Rust Functions</h4><p>In order to set up the stack properly to call Rust functions, like
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">print_snake_val</code></span> and your error functions, it&rsquo;s necessary to
make a few changes to what we had in Boa.</p><ul><li><p> When calling a Rust function such as <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">print_snake_val</code></span>, you need
to ensure that you decrement <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">RSP</code></span> enough to move it past all of
your local variables before the call and then reverse this by
incrementing it after the call returns.</p><p>To figure out how much space, you need to implement the
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">space_needed</code></span> function. There are many ways to implement this,
but you need to make sure that you have enough space to fit all of
your local variables and that you keep the stack aligned.</p><p>When you make a function call, you must ensure that before the
<span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">call</code></span> instruction the stack pointer <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">rsp</code></span> is 16-byte aligned,
i.e., divisible by 16. As discussed in <a href="lec_errors_notes.html" data-pltdoc="x">Lecture 7</a>, you can
achieve this by allocating one extra slot on the stack if you would
otherwise be misaligned.</p></li><li><p>Participating in the stack: As a callee using the System V AMD64 calling
convention, our code has some responsibilities. First, we need to
store any callee-save registers that we use in the code upon
entry. So if you are using any of the callee-save registers as scratch registers, you should push them upon entry into <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">start_here</code></span> and pop them back off before the final return.</p></li></ul><p>If you write any functions in <code>stub.rs</code> that you need to be available in
your assembly, you need to declare them in the assembly via:</p><p><div class="sourceCodeWrapper"><span data-label="X64 Assembly" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-asm64" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">;; In your generated assembly
extern "sysv64" &lt;exported name of function&gt;</code></pre></div></div></p><h4>3.3<tt>&nbsp;</tt><a name="(part._.New_.Assembly_.Constructs)"></a>New Assembly Constructs</h4><ul><li><p><span title="OCaml" class="sourceCode"><code data-lang="text/x-ocaml" class="sourceCode">Sized</code></span>: You may run into errors that report that the size of an
operation is ambiguous. This could happen if you write, for example:</p><p><div class="sourceCodeWrapper"><span data-label="X64 Assembly" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-asm64" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">cmp [RSP - 8], 0</code></pre></div></div></p><p>because the assembler doesn&rsquo;t know if the program should compare a four-byte
zero, a one-byte zero, or something in between into memory starting at
<span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">[RSP - 8]</code></span>. To solve this, you can supply a size:</p><p><div class="sourceCodeWrapper"><span data-label="X64 Assembly" class="sourceLangLabel"></span><div class="sourceCode"><pre data-lang="text/x-asm64" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">cmp QWORD [RSP - 8], 0</code></pre></div></div></p><p>The <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">QWORD</code></span> keyword tells the assembler to use the "quad word"
size for the memory reference. In our generated assembly code we have
always worked at the full 64-bit word level so it is fine to just
change all memory references to use the <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">QWORD</code></span> keyword. If you do
not want every memory reference to use the keyword feel free to change
types in <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">asm.rs</code></span> to support more selective use.</p></li><li><p><span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Unsigned vs Signed</code></span>: Assembly code supports 64-bit
unsigned and signed constants and certain values like the
representation of <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">true</code></span>, <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">false</code></span> and bit patterns cannot
be represented as <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">i64</code></span> values. So the
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Arg64</code></span>/<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Arg32</code></span>/<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Reg32</code></span> types have replaced the
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Imm</code></span> with two cases for <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Signed</code></span> and <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Unsigned</code></span>
constants. I recommend displaying <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Unsigned</code></span> constants in
hexadecimal since you will probably only be using them for
bit-patterns. To format a number <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">n</code></span> in hexadecimal, you can use
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">format!("0x{:016x}", n)</code></span> for 64-bit numbers and
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">format!("0x{:08x}", n)</code></span> for 32-bit.</p></li><li><p><span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">push</code></span>, <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">pop</code></span>: These two instructions manage values on the
stack. <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">push</code></span> adds a value at the current location of <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">rsp</code></span>, and
decrements <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">rsp</code></span> to point past the added value (remember, the stack grows
toward numerically-smaller addresses, even though we draw it as
growing upward in diagrams). <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">pop</code></span> increments
<span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">rsp</code></span> and moves the value at the location <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">rsp</code></span> was pointing to into
the provided arg.</p></li><li><p>A <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">call</code></span> does two things:</p><ul><li><p>Pushes the next code location onto the stack (just like a <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">push</code></span>), which becomes the return pointer</p></li><li><p>Performs an unconditional jump to the provided label</p></li></ul></li><li><p><span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">shr</code></span>, <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">shl</code></span>, <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">sar</code></span>: Bit shifting operations.  <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">sar</code></span>
(shift-arithmetic-right) preserves the sign bit of the value being shifted,
while <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">shr</code></span> (shift-right) simply fills in a zero bit.</p></li><li><p><span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">and</code></span>, <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">or</code></span>, <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">xor</code></span>: Bitwise logical operations.</p></li><li><p><span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">test</code></span>: Performs a bitwise-and of the two arguments, and records
whether the result was zero, signed, or overflowed.  This can be used in tandem
with jumps like <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">jo</code></span> or <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">jz</code></span>.</p></li><li><p><span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">jo</code></span>, <span title="X64 Assembly" class="sourceCode"><code data-lang="text/x-asm64" class="sourceCode">jno</code></span>: Jump to the provided label if the last arithmetic
operation did/did not overflow.</p></li><li><p><span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Comment</code></span>: these allow you to add a
comment on a line by itself, or in-line after an instruction.  These might be
helpful for readability of your generated output, while you&rsquo;re debugging.</p></li></ul><h4>3.4<tt>&nbsp;</tt><a name="(part._.Debugging)"></a>Debugging</h4><p><p>If you are having trouble producing correct code, I highly recommend
</p><ul><li><p>Inspecting your generated assembly code</p></li><li><p>Print out intermediate expressions using <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">println!("{:?}", e)</code></span></p></li><li><p>Finding minimal examples that produce incorrect behavior</p></li></ul></p><h3>4<tt>&nbsp;</tt><a name="(part._.Recommended_.T.O.D.O_.List)"></a>Recommended TODO List</h3><p>Here&rsquo;s an order in which you could consider tackling the implementation:</p><ol><li><p>Fix the Num case and implement the Bool case of the compiler to
correctly encode the values.</p></li><li><p>Extend <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">check</code></span> (renamed from <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">check_scope</code></span>) to use the
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Overflow</code></span> error to indicate integer constants that are too big
to fit into 63-bit signed integers.</p></li><li><p>Implement the <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Prim2</code></span> operations without checking runtime
type tags. Test your arithmetic and logical operations with programs
where the tag checks would succeed.</p></li><li><p>Similarly, implement the <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">Prim1</code></span> operations besides
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">print</code></span> without checking runtime type tags.</p></li><li><p>Figure out how to test for errors and call the
<span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">snake_error</code></span> function when an error is detected. Test as you
go. Be aware that if the function call segfaults, it may be because
you need to refine your <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">space_needed</code></span> function.</p></li><li><p>Complete the if case and test as you go.</p></li><li><p>Implement <span title="Cobra" class="sourceCode"><code data-lang="text/x-snake" class="sourceCode">print</code></span> and in the process <span title="Rust" class="sourceCode"><code data-lang="text/x-rustsrc" class="sourceCode">space_needed</code></span>. Test as you go; be aware that you
should test interesting sequences of print expressions and let-bindings to make
sure your stack integrity is good before and after calls.</p></li></ol><p>Be sure to get your alignment correct! Stack misalignment does not
cause errors on Mac, but does on Linux and in particular on the
autograder servers so if you are getting errors you can&rsquo;t replicate on
Mac, make sure to think about alignment.</p><h3>5<tt>&nbsp;</tt><a name="(part._.Running_main)"></a>Running main</h3><p>Running your own programs is the same as with Boa, except you&rsquo;ll give them
the <code>.cobra</code> file extension.</p><h3>6<tt>&nbsp;</tt><a name="(part._.List_of_.Deliverables)"></a>List of Deliverables</h3><ul><li><p>your <code>compile.rs</code> and <code>asm.rs</code></p></li><li><p>the other src/*.rs files in the starter code</p></li><li><p>any additional modules you saw fit to write</p></li><li><p>your <code>runtime/stub.rs</code></p></li><li><p>the Cargo.toml</p></li><li><p>integration tests (<code>tests/examples.rs</code>)</p></li><li><p>your test input programs (<code>examples/*.cobra</code> files)</p></li></ul><p><span style="font-weight: bold">Please ensure the your code builds properly. The autograder
will give you a 0 on that portion of the graade if it cannot compile
your code.</span></p><h3>7<tt>&nbsp;</tt><a name="(part._.Grading_.Standards)"></a>Grading Standards</h3><p><p>For this assignment, you will be graded on
</p><ul><li><p>Whether your code implements the specification (functional correctness),</p></li></ul></p><h3>8<tt>&nbsp;</tt><a name="(part._.Submission)"></a>Submission</h3><p><p><span style="font-weight: bold">Wait!</span> Please read the assignment again and verify that you have not forgotten anything!</p></p><p>Please submit your homework to gradescope by the above deadline.</p><a name="(part._(gentag._4._assignmentcobra))"></a><p class="FootnoteBlock"></p></div></div><div id="contextindicator">&nbsp;</div></body></html>